## ê°œë°œí™˜ê²½

### ì„œë²„ í™˜ê²½ ë° ë²„ì „

- `Linux` : 20.04.6 LTS
- `java`: 17
- `gradle` : 8.5
- `SpringBoot` : 3.2.2
- `Django`: 3.2.23
- `React` : 18.2.4

## .gitignore

- Front-end : .env
- Back-end : *.yml
- .yml
    - discovery-service
        
        ```bash
        server:
          port: 8761
        
        spring:
          application:
            name: discoveryservice
        
        eureka:
          instance:
            prefer-ip-address: true
          client:
            register-with-eureka: false
            fetch-registry: false
        ```
        
    - apigateway-service
        
        ```bash
        server:
          port: 8000
          servlet:
            context-path: /
          host: repertory.online
          ssl:
            key-store: classpath:ssl/keystore.p12
            key-store-type: PKCS12
            key-store-password: luckyturkey
        
        eureka:
          instance:
            prefer-ip-address: true
          client:
            register-with-eureka: true
            fetch-registry: true
            service-url:
              defaultZone: http://${server.host}:8761/eureka
        
        spring:
          application:
            name: apigateway
          jwt: #jwt secret Key ë‹¤ë¥¸ ì„œë²„ì™€ í•­ìƒ ê°™ê²Œ ìœ ì§€ë˜ì–´ì•¼í•¨
            secret: djklsfjisdojuihfeuibjshjkbuibihuigtyfrtxdfzxdfsawrsesxdfxdfqafxdrzd
          cloud:
            gateway:
              default-filters:
                - DedupeResponseHeader=Access-Control-Allow-Origin Access-Control-Allow-Credentials
                - name: AuthenticationFilter
              globalcors:
                cors-configurations:
                  '[/**]':
                    allowedOrigins:
                      - 'http://localhost:5173'
                      - 'https://repertory.online'
                    allow-credentials: true
                    allowedHeaders: '*'
                    allowedMethods: 
                      - PUT
                      - GET
                      - POST
                      - DELETE
                      - OPTIONS
                      - PATCH
              routes:
                - id: community
                  uri: lb://COMMUNITY
                  predicates:
                    - Path=/community/**
                - id: dance
                  uri: lb://DANCE
                  predicates:
                    - Path=/dance/**
                - id: project
                  uri: lb://PROJECT
                  predicates:
                    - Path=/project/**
                - id: member
                  uri: lb://MEMBER
                  predicates:
                    - Path=/member/**
        ```
        
    - community-service
        
        ```bash
        server:
          port: 0
          servlet:
            context-path: /community
          host: repertory.online
        
        spring:
          application:
            name: community
          jwt: #jwt secret Key ë‹¤ë¥¸ ì„œë²„ì™€ í•­ìƒ ê°™ê²Œ ìœ ì§€ë˜ì–´ì•¼í•¨
            secret: djklsfjisdojuihfeuibjshjkbuibihuigtyfrtxdfzxdfsawrsesxdfxdfqafxdrzd
          datasource:
            driver-class-name: org.mariadb.jdbc.Driver
            url: jdbc:mariadb://i10a707.p.ssafy.io:3407/community?characterEncoding=UTF-8&serverTimezone=UTC
            username: lucky
            password: turkey707
          jpa:
            hibernate:
              ddl-auto: update
            properties:
              hibernate:
                format_sql: true
                show_sql: true
          data:
            redis:
              host: i10a707.p.ssafy.io
              port: 6379
              password: luckyTurkey
        
        eureka:
          instance:
            instance-id: ${spring.cloud.client.hostname}:${spring.application.instance_id:${random.value}}
            prefer-ip-address: true
          client:
            register-with-eureka: true
            fetch-registry: true
            service-url:
              defaultZone: http://${server.host}:8761/eureka
        
        api:
          dance:
            url: http://${server.host}:8000/dance
          member:
            url: http://${server.host}:8000/member
        
        springdoc:
          api-docs:
            path: /api-docs
          swagger-ui:
            path: /swagger-ui.html
        
        openapi:
          service:
            url: http://${server.host}:8000
        ```
        
    - dance-service
        
        ```bash
        server:
          port: 0
          servlet:
            context-path: /dance
          host: repertory.online
        
        eureka:
          instance:
            instance-id: ${spring.cloud.client.hostname}:${spring.application.instance_id:${random.value}}
            prefer-ip-address: true
          client:
            register-with-eureka: true
            fetch-registry: true
            service-url:
              defaultZone: http://${server.host}:8761/eureka
        
        spring:
          application:
            name: dance
          jwt:
            secret: djklsfjisdojuihfeuibjshjkbuibihuigtyfrtxdfzxdfsawrsesxdfxdfqafxdrzd
          servlet:
            multipart:
              enabled: true
              max-file-size: 20MB
              max-request-size: 20MB
          # for production
          datasource:
            driver-class-name: org.mariadb.jdbc.Driver
            url: jdbc:mariadb://repertory.online:3407/dance?characterEncoding=UTF-8&serverTimezone=UTC
            username: lucky
            password: turkey707
        
          jpa:
            hibernate:
              ddl-auto: update
          jooq:
            sql-dialect: org.hibernate.dialect.H2Dialect
        
          data:
            mongodb:
              username: lucky
              password: turkey707
              host: repertory.online
              port: 27017
              database: testdb
              authentication-database: admin
        
            redis:
              host: repertory.online
              port: 6379
              password: luckyTurkey
        
        logging:
          level:
            sql: debug
            web: debug
            team.luckyturkey.danceservice: debug
            org.springframework.data.redis: debug
        
        api:
          community:
            url: http://${server.host}:8000/community
        
        #only for test environment
        test:
          environment:
            memberId: 1
            sourceUrl: s3//test-source-url/
            repertoryUrl: s3//test-repertory-url/
        
        cloud:
          aws:
            s3:
              bucket: repertory
              base-url: http://repertory.s3.ap-northeast-2.amazonaws.com/
            stack.auto: false
            region.static: ap-northeast-2
            credentials:
              accessKey: AKIAWHZZMWNCD6BWMOM3
              secretKey: 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
        ```
        
    - project-service
        
        ```bash
        server:
          port: 0
          servlet:
            context-path: /project
          host: repertory.online
        
        spring:
          application:
            name: project
          jwt:
            secret: djklsfjisdojuihfeuibjshjkbuibihuigtyfrtxdfzxdfsawrsesxdfxdfqafxdrzd
          data:
            mongodb:
              uri: mongodb://lucky:turkey@repertory.online:27017/project
        
        logging:
          level:
            org.springframework.data.mongodb: debug
            web: debug
        
        eureka:
          instance:
            instance-id: ${spring.cloud.client.hostname}:${spring.application.instance_id:${random.value}}
            prefer-ip-address: true
          client:
            register-with-eureka: true
            fetch-registry: true
            service-url:
              defaultZone: http://${server.host}:8761/eureka
        
        cloud:
          aws:
            s3:
              bucket: repertory
              base-url: http://repertory.s3.ap-northeast-2.amazonaws.com/
            stack.auto: false
            region.static: ap-northeast-2
            credentials:
              accessKey: AKIAWHZZMWNCD6BWMOM3
              secretKey: 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
        ```
        
    - member-service
        
        ```bash
        server:
          port: 0
          servlet:
            context-path: /member
          host: repertory.online
        
        eureka:
          instance:
            instance-id: ${spring.cloud.client.hostname}:${spring.application.instance_id:${random.value}}
            prefer-ip-address: true
          client:
            register-with-eureka: true
            fetch-registry: true
            service-url:
              defaultZone: http://${server.host}:8761/eureka
        
        spring:
          profiles:
            include: oauth
          application:
            name: member
          datasource:
            driver-class-name: org.mariadb.jdbc.Driver
            url: jdbc:mariadb://repertory.online:3407/member?characterEncoding=UTF-8&serverTimezone=UTC
            username: lucky
            password: turkey707
          jwt: #jwt secret Key ë‹¤ë¥¸ ì„œë²„ì™€ í•­ìƒ ê°™ê²Œ ìœ ì§€ë˜ì–´ì•¼í•¨
            secret: djklsfjisdojuihfeuibjshjkbuibihuigtyfrtxdfzxdfsawrsesxdfxdfqafxdrzd
        
          jpa:
            hibernate:
              ddl-auto: update
        #      naming:
        #        physical-strategy: org.hibernate.boot.model.naming.PhysicalNamingStrategyStandardImpl
        
        redis:
          host: repertory.online
          port: 6379
          password: luckyTurkey
        ```
        
        ```bash
        spring:
          security:
            oauth2:
              client:
                registration:
                  google:
                    client-name: google
                    client-id: 369405807431-pki0r440oh137ckh7lmotdof8sat2eot.apps.googleusercontent.com
                    client-secret: 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
                    redirect-uri: http://localhost:8080/member/login/oauth2/code/google #todo : ë¦¬ë‹¤ì´ë ‰íŠ¸ uri ë°”ê¾¸ê¸°, êµ¬ê¸€ì—ì„œë„
                    authorization-grant-type: authorization_code
                    scope: profile,email #openId ê°’ ë„˜ì–´ì˜¤ì§€ë§Œ êµ³ì´ ì•ˆë°›ìŒ
        ```
        

## ì™¸ë¶€ ì„œë¹„ìŠ¤ ì •ë³´

- êµ¬ê¸€ ë¡œê·¸ì¸ API
    - https://repertory.online:8000/member/oauth2/authorization/google
- AWS S3 ì„¤ì •
    - ë²„í‚· ë¦¬ì†ŒìŠ¤ ì´ë¦„ : arn:aws:s3:::repertory
    - ë²„í‚·ì •ì±…
    
    ```bash
    {
        "Version": "2012-10-17",
        "Id": "Policy1706854428642",
        "Statement": [
            {
                "Sid": "Stmt1706854426665",
                "Effect": "Allow",
                "Principal": "*",
                "Action": [
                    "s3:GetObject",
                    "s3:PutObject"
                ],
                "Resource": "arn:aws:s3:::repertory/*"
            }
        ]
    }
    ```
    
    - CORS ì„¤ì •
    
    ```bash
    [
        {
            "AllowedHeaders": [
                "*"
            ],
            "AllowedMethods": [
                "HEAD",
                "GET",
                "PUT",
                "POST",
                "DELETE"
            ],
            "AllowedOrigins": [
                "http://localhost:5173",
                "https://repertory.online"
            ],
            "ExposeHeaders": [
                "ETag",
                "x-amz-meta-custom-header"
            ]
        }
    ]
    ```
    

# Front-end

## ì‹¤í–‰ ë°©ë²•

1. FE í´ë”ë¡œ ì´ë™
2. ë‹¤ìŒ ëª…ë ¹ì–´ ì‹¤í–‰

```bash
npm i
npm run build
```

## Nginx ì„¤ì •

- .conf
    
    ```bash
    # Default server configuration
    #
    server {
    	listen 80 default_server;
    	listen [::]:80 default_server;
    
    	root /var/www/html;
    
    	# Add index.php to the list if you are using PHP
    	index index.html index.htm index.nginx-debian.html;
    
    	server_name _;
    
    	location / {
    		# First attempt to serve request as file, then
    		# as directory, then fall back to displaying a 404.
    		try_files $uri $uri /index.html;
    	}
    
    }
    
    server {
    
    	root /var/www/html;
    
    	# Add index.php to the list if you are using PHP
    	index index.html index.htm index.nginx-debian.html;
        server_name i10a707.p.ssafy.io; # managed by Certbot
    
    	location / {
    		# First attempt to serve request as file, then
    		# as directory, then fall back to displaying a 404.
    		try_files $uri $uri/ /index.html;
    	}
    
        listen [::]:443 ssl ipv6only=on; # managed by Certbot
        listen 443 ssl; # managed by Certbot
        ssl_certificate /etc/letsencrypt/live/i10a707.p.ssafy.io/fullchain.pem; # managed by Certbot
        ssl_certificate_key /etc/letsencrypt/live/i10a707.p.ssafy.io/privkey.pem; # managed by Certbot
        include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot
        ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot
    
    }
    
    server {
        if ($host = i10a707.p.ssafy.io) {
            return 301 https://$host$request_uri;
        } # managed by Certbot
    
    	listen 80 ;
    	listen [::]:80 ;
        server_name i10a707.p.ssafy.io;
        return 404; # managed by Certbot
    
    }
    server {
    
    	root /var/www/html;
    
    	# Add index.php to the list if you are using PHP
    	index index.html index.htm index.nginx-debian.html;
        server_name repertory.online; # managed by Certbot
    
    	location / {
    		# First attempt to serve request as file, then
    		# as directory, then fall back to displaying a 404.
    		try_files $uri /index.html;
    	}
    
        listen [::]:443 ssl; # managed by Certbot
        listen 443 ssl; # managed by Certbot
        ssl_certificate /etc/letsencrypt/live/repertory.online/fullchain.pem; # managed by Certbot
        ssl_certificate_key /etc/letsencrypt/live/repertory.online/privkey.pem; # managed by Certbot
        include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot
        ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot
    
    }
    
    server {
        if ($host = repertory.online) {
            return 308 https://$host$request_uri;
        } # managed by Certbot
    
    	listen 80 ;
    	listen [::]:80 ;
        server_name repertory.online;
        return 404; # managed by Certbot
    }
    ```
    
- `[i10a707.p.ssafy.io](http://i10a707.p.ssafy.io)` ì™€ `[repertory.online](http://repertory.online)` ë„ë©”ì¸ì— ëŒ€í•œ ì„¤ì •

# Back-end

## 1ï¸âƒ£ EC2 í™˜ê²½ ì„¤ì •

1. MobaXTerm ì„¤ì¹˜
2. EC2 Instanceì— Linux OS (ubuntu) ì„¤ì¹˜ - ë²„ì „ ì°¸ê³ 
3. EC2 Instanceì— Docker ì„¤ì¹˜

```bash
sudo apt-get -y install docker-ce docker-ce-cli containerd.io
```

## 2ï¸âƒ£ Docker Container ìƒì„± - DB

<aside>
ğŸ“¢ í•´í‚¹ ë°©ì§€ë¥¼ ìœ„í•´ í¬íŠ¸í¬ì›Œë”©ê³¼ ê°•ë ¥í•œ ë¹„ë°€ë²ˆí˜¸ ì„¤ì •

</aside>

1. **MariaDB**

```bash
// docker image download
docker pull mariadb:latest

// docker container create and start
docker run -p 3407:3306 --name mariadb -e MARIADB_ROOT_PASSWORD=lucky707turkey707 -d mariadb

// docker container execution
docker exec -it mariadb mariadb --u lucky -p
```

1. **MongoDB**

```bash
// docker image download
docker pull mongo:latest

// docker container create and start
docker run --name mongodb -v ~/data:/data/db -d -p 27017:27017 mongo

// docker container execution
docker exec -it mongodb mongosh -u lucky -p
```

1. **Redis**

```bash
// docker image download
docker pull redis:latest

// docker container create and start
docker run --name redis -d -p 6379:6379 redis

// docker container execution
docker exec -it redis redis-cli
```

## Docker Container ìƒì„± - Jenkins

```bash
// docker image download
docker pull jenkins/jenkins:jdk17

// docker container create and start
docker run -d --restart always --env JENKINS_OPTS=--httpPort=8080 -v /etc/localtime:/etc/localtime:ro -e TZ=Asia/Seoul -p 8080:8080 -v /jenkins:/var/jenkins_home -v /var/run/docker.sock:/var/run/docker.sock -v /usr/local/bin/docker-compose:/usr/local/bin/docker-compose --name jenkins -u root jenkins/jenkins:jdk17
```

### Jenkins ì„¤ì •

## ì  í‚¨ìŠ¤ ì„¤ì •

### ì  í‚¨ìŠ¤ ì´ˆê¸° ì„¤ì •

- ìƒˆë¡œìš´ ì•„ì´í…œ ë§Œë“¤ê¸°
- ì  í‚¨ìŠ¤ í”ŒëŸ¬ê·¸ì¸ ì„¤ì¹˜

```bash
SSH Agent

Docker
Docker Commons
Docker Pipeline
Docker API

Generic Webhook Trigger

GitLab
GitLab API
GitLab Authentication
GitHub Authentication
```

- GitLab Webhook ì§€ì •
- DockerHub  í† í° ë°œê¸‰ ë° ë ˆí¬ì§€í† ë¦¬ ìƒì„±

## Jenkins Credential ì¶”ê°€

- gitlab token (Username with password)
- gitlab project token (Gitlab API Token)
- ubuntu SSH key (SSH Username with private key)
- dockerhub (username with password - id: docker-hub-credentials)
- ssl ì¸ì¦ì„œ íŒŒì¼ (Sercret.file)
- ì„œë¹„ìŠ¤ ë³„ application.yml (Secret file - id: {servceName}-yml}

### Jenkins Pipeline

```bash
pipeline {
    agent any

    environment {
        releaseServerAccount = 'ubuntu'
        releaseServerUri = 'i10a707.p.ssafy.io'
        imageName = "zoohee/a707-backend"
    }

    stages {
        stage("SCM"){
            steps{
                git branch: 'dev/BE',
                        credentialsId: 'gitlab',
                        url: 'https://lab.ssafy.com/s10-webmobile1-sub2/S10P12A707.git'
            }
        }
        stage('Build with Gradle') {
            steps {
                script {
                    try {
                        def gitDiffResult = sh(script: "git diff --name-only HEAD^ HEAD", returnStdout: true).trim()
                        println("gitDiffResult: " + gitDiffResult)

                        def egrepResult = sh(script: "echo '${gitDiffResult}' | egrep '(\\.java|\\.gradle|\\.properties|Dockerfile)\$' || true", returnStdout: true).trim()
                        println("egrepResult: " + egrepResult)

                        def services = sh(script: "echo '${egrepResult}' | cut -d/ -f2 | uniq", returnStdout: true).trim().split("\n")
                        println("services: " + services)
                        
                        def credentialsList = ['dance-service': 'dance-yml', 'community-service': 'community-yml', 'apigateway-service': 'apigateway-yml', 'project-service': 'project-yml', 'member-service': 'member-yml']
                        def sslkey = 'ssl-key'

                        for (service in services) {
                            dir('BE') {
                                dir(service) {
                                    
                                    if (service == 'apigateway-service') {
                                        withCredentials([file(credentialsId: 'sslkey', variable: 'configFile')]) {
                                            sh "cp \$configFile src/main/resources/ssl/keystore.p12"
                                        }
                                    }
                                    
                                    def credentialId = credentialsList[service]
                                    if (credentialId != "") {
                                        println(credentialId)
                                        withCredentials([file(credentialsId: credentialId, variable: 'configFile')]) {
                                            sh "cp \$configFile src/main/resources/application.yml"
                                        }
                                    }
                                    
                                    if (service == 'member-service') {
                                        withCredentials([file(credentialsId: 'member-oauth-yml', variable: 'configFile')]) {
                                            sh "cp \$configFile src/main/resources/application-oauth.yml"
                                        }
                                    }
                                    
                                    sh "chmod +x gradlew" // ì‹¤í–‰ ê¶Œí•œ ì¶”ê°€
                                    sh "./gradlew build -x test"
                                }
                            }
                        }
                    } catch (Exception e) {
                        println("Error: " + e.getMessage())
                    }
                }
            }
        }
        stage('Build and Push Docker Images') {
            steps {
                script {
                    docker.withRegistry('https://registry.hub.docker.com/', 'docker-hub-credentials') {
                        try {
                            def gitDiffResult = sh(script: "git diff --name-only HEAD^ HEAD", returnStdout: true).trim()
                            println("gitDiffResult: " + gitDiffResult)

                            def egrepResult = sh(script: "echo '${gitDiffResult}' | egrep '(\\.java|\\.gradle|\\.properties|\\.yml|Dockerfile)\$' || true", returnStdout: true).trim()
                            println("egrepResult: " + egrepResult)

                            def services = sh(script: "echo '${egrepResult}' | cut -d/ -f2 | uniq", returnStdout: true).trim().split("\n")
                            println("services: " + services)

                            for (service in services) {
                                dir('BE') {
                                    dir(service) {
                                        sh "docker buildx build -f Dockerfile -t zoohee/a707-backend:${service} . --load"
                                        sh "docker login -u ${DOCKERHUB_USERNAME} -p ${DOCKERHUB_PASSWORD}"
                                        sh "docker push zoohee/a707-backend:${service}"
                                    }
                                }

                            }

                        }
                        catch (Exception e) {
                            println("Error: " + e.getMessage())
                        }
                    }
                }
            }
        }

        stage('Before Service Stop') {
            steps {
                script {
                    docker.withRegistry('https://registry.hub.docker.com/', 'docker-hub-credentials') {
                        try {
                            def gitDiffResult = sh(script: "git diff --name-only HEAD^ HEAD", returnStdout: true).trim()
                            println("gitDiffResult: " + gitDiffResult)

                            def egrepResult = sh(script: "echo '${gitDiffResult}' | egrep '(\\.java|\\.gradle|\\.properties|\\.yml|Dockerfile)\$' || true", returnStdout: true).trim()
                            println("egrepResult: " + egrepResult)

                            def services = sh(script: "echo '${egrepResult}' | cut -d/ -f2 | uniq", returnStdout: true).trim().split("\n")
                            println("services: " + services)

                            for (service in services) {
                                    sshagent(credentials: ['ubuntu']) {
                                        def serviceName = "${service}" // ë³€ìˆ˜ ì„ ì–¸
                                        sh """
                                            targetHost=$releaseServerAccount@$releaseServerUri
                                            imageFullName=$imageName:$serviceName
                                            
                                            CONTAINER_ID=\$(ssh -o StrictHostKeyChecking=no \$targetHost "sudo docker ps -aq --filter name=$serviceName")
                                            IMAGE_ID=\$(ssh -o StrictHostKeyChecking=no \$targetHost "sudo docker images -q \$imageFullName")
                                            
                                            if [ "\$CONTAINER_ID" != "" ]; then
                                                ssh -o StrictHostKeyChecking=no \$targetHost "sudo docker stop $serviceName"
                                                ssh -o StrictHostKeyChecking=no \$targetHost "sudo docker rm -f $serviceName"
                                            fi
                                            if [ "\$IMAGE_ID" != "" ]; then
                                                ssh -o StrictHostKeyChecking=no \$targetHost "sudo docker rmi \$IMAGE_ID"
                                            fi
                                        """
                                }
                            }
                            sh "docker image prune --force"

                        }

                        catch (Exception e) {
                            println("Error: " + e.getMessage())
                        }
                    }
                }
            }
        }

        stage('DockerHub Pull') {
            steps {
                script {
                    docker.withRegistry('https://registry.hub.docker.com/', 'docker-hub-credentials') {
                        try {
                            def gitDiffResult = sh(script: "git diff --name-only HEAD^ HEAD", returnStdout: true).trim()
                            println("gitDiffResult: " + gitDiffResult)

                            def egrepResult = sh(script: "echo '${gitDiffResult}' | egrep '(\\.java|\\.gradle|\\.properties|\\.yml|Dockerfile)\$' || true", returnStdout: true).trim()
                            println("egrepResult: " + egrepResult)

                            def services = sh(script: "echo '${egrepResult}' | cut -d/ -f2 | uniq", returnStdout: true).trim().split("\n")
                            println("services: " + services)

                            for (service in services) {
                                dir('BE') {
                                    dir(service) {
                                        sshagent(credentials: ['ubuntu']) {
                                            sh "ssh -o StrictHostKeyChecking=no $releaseServerAccount@$releaseServerUri 'sudo docker pull $imageName:${service}'"
                                        }
                                    }
                                }
                            }
                        }

                        catch (Exception e) {
                            println("Error: " + e.getMessage())
                        }
                    }
                }
            }
        }

        stage('Service Start') {
            steps {
                script {
                    docker.withRegistry('https://registry.hub.docker.com/', 'docker-hub-credentials') {
                        try {
                            def gitDiffResult = sh(script: "git diff --name-only HEAD^ HEAD", returnStdout: true).trim()
                            println("gitDiffResult: " + gitDiffResult)

                            def egrepResult = sh(script: "echo '${gitDiffResult}' | egrep '(\\.java|\\.gradle|\\.properties|\\.yml|Dockerfile)\$' || true", returnStdout: true).trim()
                            println("egrepResult: " + egrepResult)

                            def services = sh(script: "echo '${egrepResult}' | cut -d/ -f2 | uniq", returnStdout: true).trim().split("\n")
                            println("services: " + services)

                            for (service in services) {
                                dir('BE') {
                                    dir(service) {
                                        def serviceName
                                        sshagent(credentials: ['ubuntu']) {
                                            serviceName = "${service}"
                                            
                                            if (serviceName == 'apigateway-service') {
                                                sh """
                                                    ssh -o StrictHostKeyChecking=no $releaseServerAccount@$releaseServerUri 'sudo docker run -i -p 8000:8000 -e TZ=Asia/Seoul -e SPRING_PROFILES_ACTIVE=prod --name $serviceName -d $imageName:$serviceName'
                                                """
                                            } else {
                                                sh """
                                                    ssh -o StrictHostKeyChecking=no $releaseServerAccount@$releaseServerUri 'sudo docker run -i -e TZ=Asia/Seoul -e SPRING_PROFILES_ACTIVE=prod --name $serviceName -d $imageName:$serviceName'
                                                """
                                            }
                                        }
                                    }
                                }
                            }

                        }

                        catch (Exception e) {
                            println("Error: " + e.getMessage())
                        }
                    }
                }
            }
        }

    }
}
```

1. SCM
    1. target branchë¥¼ ì„¤ì •í•œë‹¤.
2. Build with  Gradle
    1. branchì—ì„œ ë³€ê²½ëœ ì„œë¹„ìŠ¤ë§Œ ê°ì§€í•˜ì—¬ ì„œë¹„ìŠ¤ ëª©ë¡ì„ ë§Œë“ ë‹¤.
    2. ì„œë¹„ìŠ¤ë³„ë¡œ í•„ìš”í•œ yml íŒŒì¼ì„ credentialì—ì„œ ì°¾ì•„ ì£¼ì…í•œë‹¤.
    3. gradle ë¹Œë“œë¥¼ ì§„í–‰í•œë‹¤.
3. Build and Push Docker Images
    1. ê° ì„œë¹„ìŠ¤ë³„ Dockerfileì„ ì´ìš©í•´ì„œ imageë¥¼ ìƒì„±í•œë‹¤.
    2. dockerhubì— imageë¥¼ pushí•œë‹¤.
4. Before Service Stop
    1. EC2 ì„œë²„ì— ì›ê²© ì ‘ì†í•˜ì—¬ ê¸°ì¡´ ì„œë¹„ìŠ¤ì˜ ì´ë¯¸ì§€ì™€ ì»¨í…Œì´ë„ˆë¥¼ ë©ˆì¶”ê³  ì‚­ì œí•œë‹¤.
5. DockerHub Pull
    1. DockerHubì—ì„œ ìƒˆë¡œìš´ ì´ë¯¸ì§€ë¥¼ ë‹¤ìš´ë°›ëŠ”ë‹¤.
6. Service Start
    1. ìƒˆë¡œ ë‹¤ìš´ë°›ì€ ì´ë¯¸ì§€ë¡œ ì„œë¹„ìŠ¤ë¥¼ ì‹¤í–‰í•œë‹¤.

## 3ï¸âƒ£ Eureka ì„œë²„ ì‹¤í–‰

```bash
// docker image download
docker pull zoohee/a707-backend:discovery-service

// docker container create and start
docker run -d --restart always -e TZ=Asia/Seoul -p 8761:8761/tcp --name eureka-server zoohee/a707-backend:discovery-service
```

## 4ï¸âƒ£ microservices ì„œë²„ ì‹¤í–‰

- Intellijì—ì„œ ì‹¤í–‰ (localhost)
    - SpringBoot Applicationì— ëª¨ë“ˆë¡œ ë‹¤ ë“±ë¡ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
    - application.yml ì„œë¹„ìŠ¤ ë³„ë¡œ ë‹¤ì‹œ ë“±ë¡
    - hostnameì„ localhostë¡œ ë³€ê²½
    - `discovery-service` â†’ `apigateway-service` â†’ `services` ìˆœìœ¼ë¡œ ì‹¤í–‰
- ìˆ˜ë™ ì‹¤í–‰

```bash
// docker image download
docker pull zoohee/a707-backend:{serviceName}

// docker container create and start
// serviceNames = ['community-service', 'dance-service', 'project-service', 'member-service', 'pose-service']
docker run -d --restart always -e TZ=Asia/Seoul --name {serviceName} zoohee/a707-backend:{serviceName}
```

- ìë™ ì‹¤í–‰

```bash
// GitHub all services in develop branch Push
// Automatically deployed and executed
```

## MySQL Workbench Connection

- New connection
    - Hostname: repertory.online
    - Port: 3407
    - Username: lucky
    - Password: turkey707

<aside>
ğŸ“¢ íŠ¸ëŸ¬ë¸”ìŠˆíŒ… : í•œê¸€ ë°ì´í„° ì…ë ¥ ì•ˆ ë˜ëŠ” ì´ìŠˆ â†’ ì•„ë˜ ëª…ë ¹ì–´ ì…ë ¥

</aside>

```bash
alter database [schemaëª…] default character set = utf8;
```

## SSL ì¸ì¦ì„œ ë“±ë¡

- Letâ€™sEncrypt ì¸ì¦ì„œ ë°œí–‰

```bash
sudo apt-add-repository -r ppa:certbot/certbot
sudo apt-get -y install python3-certbot-nginx
sudo certbot --nginx -d develop.code-speed.com
```

- fullchain.pemê³¼ privkey.pem ë°œê¸‰
- .pem íŒŒì¼ì€ spring cloud gatewayê°€ ì¸ì‹ ëª»í•˜ë¯€ë¡œ p.12 í˜•ì‹ìœ¼ë¡œ ë°œê¸‰

```bash
sudo openssl pkcs12 -export -in fullchain.pem -inkey privkey.pem -out keystore.p12 -name ttp -CAfile chain.pem -caname root
```

- ë°œê¸‰ëœ ë¹„ë°€ë²ˆí˜¸ ê¸°ì–µí•´ë‘ê¸°
- ë°œê¸‰ëœ ì¸ì¦ì„œ íŒŒì¼ ë³µì‚¬í•´ì„œ apigateway-serviceì˜ resources/ssl ë””ë ‰í† ë¦¬ì— ë„£ì–´ì¤€ë‹¤.
- application.yml ì„¤ì •

```bash
server:
  ssl:
    key-store: classpath:ssl/keystore.p12
    key-store-type: PKCS12
    key-store-password: luckyturkey
```